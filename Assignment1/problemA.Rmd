---
output: html_document
editor_options: 
  chunk_output_type: console
chunk_output_type: console
---

```{r}
source('setup.R')
```

```{r}
rm(list=ls())
library(ggplot2)
library(knitr)
library(RColorBrewer)
library(tidyverse)
library(latex2exp)
library(car)
library(xtable)
library(gridExtra)
```

# Problem A
```{r}
df1=read.csv(file="./Data/clothingFull.csv")
df2=read.csv(file="./Data/clothingSum.csv")
names(df2)[5]="tIn"

```
A general linear model (GLM) predicting the level of clothing (clo) using outdoor temperature (tOut), indoor operating temperature (tInOp) and gender (sex) of the subject as explanatory variables will be fitted. The full GLM model using all variables and interactions are used as a starting point, hereafter the model will be reduced using the backward selection based on Type III partitioning. Higher order variables are removed first if these are insignificant. 

```{r}
fit1=lm(clo~ tOut*tIn*sex,data=df2)
Anova(fit1, type = 'III')
#Remove third order interaction tOut:tIn:sex

fit2=lm(clo~ tOut+tIn+tOut*sex+tIn*sex,data=df2)
Anova(fit2, type = 'III')
#Remove tOut:sex

fit3=lm(clo~ tOut+tIn+tIn:sex+sex,data=df2)
Anova(fit3, type = 'III')
```
In table \ref{dev_1} the different models fitted through the backward selection are written in R notation (first column) and the statistics calculated for each model in the following columns.
\begin{table}[ht]
\centering
\begin{tabular}{lrrrrrr}
  \hline
 & Res.Df & RSS & Df & Sum of Sq & F & Pr($>$F) \\ 
  \hline
clo $\backsim$ tOut * tIn * sex & 128 & 1.82 &  &  &  &  \\ 
  clo $\backsim$ tOut + tIn + tOut * sex + tIn * sex & 130 & 1.85 & -2 & -0.02 & 0.86 & 0.4259 \\ 
  clo $\backsim$ tOut + tIn + tIn:sex + sex & 131 & 1.88 & -1 & -0.03 & 2.03 & 0.1569 \\ 
   \hline
\end{tabular}
\caption{Analysis of deviance table from backward selection of the optimal model}
\label{dev_1}
\end{table}

```{r}
#xtable(anova(fit1, fit2, fit3))
```

The result from the backward selection using Type III partitioning are given below: 

$$Clo_i =\beta_0 + \beta_1t_{Out,i} + \beta_2t_{InOp,i} + \beta_3sex_i + \beta_4t_{InOp,i}\cdot sex_i + \epsilon_i$$

```{r}
sigma_est = sigma(fit3)
anova(fit1,fit3)

lm_sigma_conf<-function(fit,CI=0.95){
  # Book page 53: sigma_hat^2~sigma^2*chisq_f/f where f=n-k
  # rearanging: sigma_hat^2*f/chisq_f
  sigma=sigma(fit)
  d_f=fit$df.residual
  conf_sigma2=d_f*sigma^2/qchisq(c((1-CI)/2,1-(1-CI)/2), df = d_f, lower.tail = FALSE)
  conf=sqrt(conf_sigma2)
  names(conf)=paste(c((1-CI)/2,1-(1-CI)/2)*100,"%")
  return(conf)
}
lm_sigma_conf(fit3)
```

where $$\epsilon_i \backsim\ N(0, \sigma^2)$$ The residuals are assumed to be i.i.d ie. $\sigma^2I$. The variance of the residuals ($\hat{\sigma^2}$) is estimated as 0.120, and an estimate of the variance and confidence hereof are computed based on theorem 3.5 resulting in the following 95\% confidence interval: [0.107, 0.136].

In the resulting model presented above the $\cdot$ indicates the interaction between the indoor operating temperature and gender of the subject. To test the model reduction, the reduced model are compared to the full initial model (first row in table \ref{dev_1}) through a likelihood-ratio-test using theorem 3.6, where the p-value is computed to: $p = 0.29$ ie. we can't reject the model reduction. 

```{r}
conf = confint(fit3)
df_param = cbind(conf[,1], fit3$coefficients, conf[,2])
#xtable(df_param)
```


\begin{table}[ht]
\centering
\begin{tabular}{rrrr}
    \hline
    & 2.5\% & Estimate & 97.5\% \\ 
  \hline
 $\hat{\beta_0} = \hat{\mu}+female$ & 1.51 & 2.13 & 2.76 \\ 
  $\hat{\beta_1}$ & -0.02 & -0.01 & -0.01 \\ 
  $\hat{\beta_2}$ & -0.07 & -0.05 & -0.02 \\ 
  $\hat{\beta_3}$ & -2.16 & -1.28 & -0.40 \\ 
  $\hat{\beta_4}$ & 0.01 & 0.04 & 0.08 \\ 
    \hline
\end{tabular}
\caption{Parameter estimates with 95\% confidence intervals}
\label{param_1}
\end{table}

The estimated parameters and 95\% confidence intervals can be seen in table \ref{param_1}. $\hat{\beta_0}$ is the intercept of the model, and contains both the intercept of the model but also the impact of being a female on the clothing level as $sex(female) = 0$, whereas $\hat{\beta_3}$ (because $sex(male) = 1$) determines the effect of being male on the clothing level. $\hat{\beta_1}$ determines the impact of the outdoor temperature on the clothing level for males and females, and as this parameter are negative higher outdoor temperatures results in lower clothing level for both males and females.$\hat{\beta_4}$ is the interaction-term between indoor operating temperature and the gender of the subject. As $sex(female) = 0$ the $\hat{\beta_2}$ must contain the information about the slope for females, whereas the interaction term $\hat{\beta_4}$ contains the changes in the slope of $\hat{\beta_2}$ for males as $t_{InOp,i}\cdot(\hat{\beta_2}+\hat{\beta_4}\cdot sex_i)$ and $sex_i$ is only equal one for men whereas the $\hat{\beta_4}$ vanishes for females resulting in $\hat{\beta_2}$ determining the slope of the indoor operating temperature for females.


```{r pred_1, fig.height=8,fig.cap="The figure presents the 95\\% prediction and confidence interval for three fixed values of the indoor operating temperature (tInOp)"}
tmp_male=data.frame(clo=NA,tOut=seq(min(df2$tOut),max(df2$tOut),0.1),tIn=quantile(df2$tIn,0.25),sex="male")
tmp_female=data.frame(clo=NA,tOut=seq(min(df2$tOut),max(df2$tOut),0.1),tIn=quantile(df2$tIn,0.25),sex="female")
new=rbind(tmp_male,tmp_female)

conf = predict(fit3,new,interval = 'confidence')
pred = predict(fit3, new,interval = 'prediction')

out = data.frame(cbind(new, conf, pred))
names(out)
q1 = ggplot(data  = out, aes(x = tOut, y = fit, col = sex)) + geom_line()+   
  geom_line(aes(x = tOut, y = lwr), lty = 2)+ geom_line(aes(x = tOut, y = upr), lty = 2)+
  geom_line(aes(x = tOut, y = upr.1), lty = 2) + geom_line(aes(x = tOut, y = lwr.1), lty = 2)+
  geom_point(data = df2, aes(x = tOut, y = clo, col= as.factor(sex))) + facet_wrap(~sex) + 
  labs(title="25% Quantile of indoor operating temperature (tInOp = 26.01)",
        x ="Outdoor temperature (tOut)", y = "Clothing level (clo)")+ theme(plot.title = element_text(hjust = 0.5))


###- Mean:
tmp_male=data.frame(clo=NA,tOut=seq(min(df2$tOut),max(df2$tOut),0.1),tIn=mean(df2$tIn),sex="male")
tmp_female=data.frame(clo=NA,tOut=seq(min(df2$tOut),max(df2$tOut),0.1),tIn=mean(df2$tIn),sex="female")
new=rbind(tmp_male,tmp_female)

conf = predict(fit3,new,interval = 'confidence')
pred = predict(fit3, new,interval = 'prediction')
out = data.frame(cbind(new, conf, pred))
q2 = ggplot(data  = out, aes(x = tOut, y = fit, col = sex)) + geom_line()+   
  geom_line(aes(x = tOut, y = lwr), lty = 2)+ geom_line(aes(x = tOut, y = upr), lty = 2)+
  geom_line(aes(x = tOut, y = upr.1), lty = 2) + geom_line(aes(x = tOut, y = lwr.1), lty = 2)+
  geom_point(data = df2, aes(x = tOut, y = clo, col= as.factor(sex))) + facet_wrap(~sex) + 
  labs(title="Mean of indoor operating temperature (tInOp = 26.82)",
        x ="Outdoor temperature (tOut)", y = "Clothing level (clo)")+ theme(plot.title = element_text(hjust = 0.5))

#75 % quantile
tmp_male=data.frame(clo=NA,tOut=seq(min(df2$tOut),max(df2$tOut),0.1),tIn=quantile(df2$tIn,0.75),sex="male")
tmp_female=data.frame(clo=NA,tOut=seq(min(df2$tOut),max(df2$tOut),0.1),tIn=quantile(df2$tIn,0.75),sex="female")
new=rbind(tmp_male,tmp_female)

conf = predict(fit3,new,interval = 'confidence')
pred = predict(fit3, new,interval = 'prediction')
out = data.frame(cbind(new, conf, pred))

q3 = ggplot(data  = out, aes(x = tOut, y = fit, col = sex)) + geom_line()+   
  geom_line(aes(x = tOut, y = lwr), lty = 2)+ geom_line(aes(x = tOut, y = upr), lty = 2)+
  geom_line(aes(x = tOut, y = upr.1), lty = 2) + geom_line(aes(x = tOut, y = lwr.1), lty = 2)+
  geom_point(data = df2, aes(x = tOut, y = clo, col= as.factor(sex))) + facet_wrap(~sex) + 
  labs(title="75% Quantile of indoor operating temperature (tInOp = 27.48)",
        x ="Outdoor temperature (tOut)", y = "Clothing level (clo)")+ theme(plot.title = element_text(hjust = 0.5))

grid.arrange(q1,q2,q3)
```

In figure \ref{fig:pred_1} 95\% confidence and prediction intervals are presented for three indoor operating temperature levels being 25\% quantile, mean and 75\% quantile. From the figure it can be seen that almost all samples for men except one lies within the prediction interval, whereas for females a few samples are out of the prediction interval. As the prediction interval only is a 95\% prediction interval it is expected that some points lies without of the interval. From the figure it should also be noted that males appears to be more constant, whereas females appear to contain larger variance. Also from the fitted line this appears to fit the male samples better than the female samples. Also it should be noted that when elevating the indoor operating temperature this results in the prediction and prediction interval for females are shifted to lower clothing levels whereas this appears to be constant for men. This also makes sense when considering the slope $t_{InOp,i}\hat{\beta_2}$ for the indoor operating temperatures effect on clothing level for females which is negative resulting in lower clothing level when the temperature rises. Whereas the effect of elevated indoor operating temperature for males are dependent on the following expression: $t_{InOp,i}\cdot(\hat{\beta_2}+\hat{\beta_4}\cdot sex_i)$ where $\hat{\beta_4}$ and $\hat{\beta_2}$ almost cancel out resulting in almost no change in clothing level when the indoor operating temperature rises.


```{r res_1,fig.height=6,fig.cap="The figure presents the residuals of the model selected from the backward selection with Type III partionioning."}
par(mfrow = c(2,2))
plot(fit3)
```
From figure \ref{fig:res_1} in the Normal-QQ plot it can be seen that the model has tails indicating the model and assumptions of the residuals does not fit the data well. It should be noted that some of the points resulting in the tails (22, 119 and 75) does not have a high leverage (looking at the Residuals vs Leverage plot) meaning that these points does not affect the model a lot compared to eg. point 2 which has a high leverage. This also indicates that outlier investigation of these three points are not necessary. From the Residuals vs Fitted and Scale-Location plots the residuals appears to be randomly distributed. 


```{r res_2,fig.height=6,fig.cap="The figure presents the residuals of the model selected from the backward selection with Type III partionioning as a function of the explanatory variables."}

df2$residual = resid(fit3)
q1 = ggplot(df2, aes(sample = residual, colour = sex)) +
  stat_qq() +
  stat_qq_line()
q2 = ggplot(data = df2, aes(x = sex, y= residual, colour = sex))+ geom_boxplot() + geom_jitter(width = 0.3) 

q3 = ggplot(data = df2, aes(x = tIn, y= residual, col = sex))+ geom_point()  + xlab('Indoor operating temperature (tInOp)')

q4 = ggplot(data = df2, aes(x = tOut, y= residual, col = sex))+ geom_point() + xlab('Outdoor temperature (tOut)')

grid.arrange(q1,q2,q3,q4, ncol = 2)
```

From figure \ref{fig:res_2} it can be seen from the boxplot that the variance of the residuals differ between males and females. When looking at the residuals as a function of indoor operating temperature and outdoor temperature the residuals appears to be randomly distributed. From the QQ-plot it should be noted that the variance of females and males also appear to be different and this could also give rise to the tails seen in figure \ref{fig:res_1}. This could indicate that the assumption that all residuals should be identical is not correct, and instead this should be shifted with an assumption of the residuals being identical within each gender group. This would result in a weighted residual model, where an optimal weight of the residuals for females compared to males needs to be estimated. In order to investigate the effect of having this weighted residual model the residuals of females are divided by the fraction (2.83) and a new QQ-plot using these residuals are presented in figure \ref{fig:res_3}. From figure \ref{fig:res_3} it can be seen that a weighting residual model appears to be beneficial. 


```{r res_3,fig.height=4,fig.cap="The figure presents a QQ-plot of the effect of normalizing the residuals across females/males "}
frac = var(resid(fit3)[df2$sex == 'female'])/var(resid(fit3)[df2$sex == 'male'])
par(mfrow=c(1,1))
res = resid(fit3)
res[df2$sex == 'female'] = res[df2$sex == 'female']/frac
qqnorm(res)
qqline(res)
```


Firstly, the optimal ratio needs to be estimated, this will be done by optimizing log-likelihood wrt. the weighting of the variance. The optimal weighting of the female residual variance is estimated to: 2.93 which will be used in the final model.
```{r}
ll_partA<-function(a,data=df2){
  weights=rep(1,nrow(data))
  weights[data$sex=="female"]=1/a
  fit=lm(clo~ tOut+tIn+tIn:sex+sex,w=weights,data=data)
  return(logLik(fit))
}
weighted_lm<-function(a,data=df2){
  weights=rep(1,nrow(data))
  weights[data$sex=="female"]=1/a
  fit=lm(clo~ tOut+tIn+tIn:sex+sex,w=weights,data=data)
  return(fit)
}
# Finding optimal weights
opt=optim(1,ll_partA,control=list(fnscale=-1),hessian=T)
# Fitting model with optimal weights
fit=weighted_lm(opt$par)
```

In order to compare the weighted model with the unweighted model AIC are used as a measure. The likelihood are not comparable as the models are not nested. The AIC are computed as: -184.59 and -202.64 for the unweighted and weighted model respectively. The weighted model appears to perform better. The model parameters and confidence intervals are presented in table \ref{par_2}.  It should be noted that $\hat{\beta_3}$ has become smaller (-1.365) compared to the previous model with -1.2834 whereas the other parameters appears to be similar. The residual variance $\hat{\sigma^2}$ is estimated to 0.085, and an estimate of the variance and confidence hereof are computed based on theorem 3.5 resulting in the following 95\% confidence interval: [0.076, 0.097]. The residual variance is smaller than for the previous model.
```{r}
conf = confint(fit)
df_param = cbind(conf[,1], fit$coefficients, conf[,2])
xtable(df_param)
c(lm_sigma_conf(fit), sigma(fit))
c(AIC(fit3), AIC(fit))
```

\begin{table}[ht]
\centering
\begin{tabular}{rrrr}
  \hline
 & 2.5\% & Estimate & 97.5 \% \\ 
  \hline
$\hat{beta_0} = \hat{\mu} + female$ & 1.49 & 2.22 & 2.95 \\ 
  $\hat{\beta_1}$ & -0.02 & -0.01 & -0.01 \\ 
  $\hat{\beta_2}$ & -0.08 & -0.05 & -0.02 \\ 
  $\hat{\beta_3}$ & -2.22 & -1.37 & -0.51 \\ 
  $\hat{\beta_4}$ & 0.02 & 0.05 & 0.08 \\ 
   \hline
\end{tabular}
\caption{Parameter estimate with 95\% confidence intervals}
\label{par_2}
\end{table}



```{r pred_2, fig.height=8,fig.cap="The figure presents the 95\\% prediction and confidence interval for three fixed values of the indoor operating temperature (tInOp)"}
tmp_male=data.frame(clo=NA,tOut=seq(min(df2$tOut),max(df2$tOut),0.1),tIn=quantile(df2$tIn,0.25),sex="male")
tmp_female=data.frame(clo=NA,tOut=seq(min(df2$tOut),max(df2$tOut),0.1),tIn=quantile(df2$tIn,0.25),sex="female")
new=rbind(tmp_male,tmp_female)

w = rep(0, length(new[,1]))
w[new$sex == 'female'] = opt$par 
w[new$sex =='male'] = 1


conf = predict(fit,new,weights = 1/w, interval = 'confidence')
pred = predict(fit, new,weights = 1/w, interval = 'prediction')

out = data.frame(cbind(new, conf, pred))
names(out)
q1 =   ggplot(data  = out, aes(x = tOut, y = fit, col = sex)) + geom_line()+   
  geom_line(aes(x = tOut, y = lwr), lty = 2)+ geom_line(aes(x = tOut, y = upr), lty = 2)+
  geom_line(aes(x = tOut, y = upr.1), lty = 2) + geom_line(aes(x = tOut, y = lwr.1), lty = 2)+
  geom_point(data = df2, aes(x = tOut, y = clo, col= as.factor(sex))) + facet_wrap(~sex) + 
  labs(title="25% Quantile of indoor operating temperature (tInOp = 26.01)",
        x ="Outdoor temperature (tOut)", y = "Clothing level (clo)")+ theme(plot.title = element_text(hjust = 0.5))


###- Mean:
tmp_male=data.frame(clo=NA,tOut=seq(min(df2$tOut),max(df2$tOut),0.1),tIn=mean(df2$tIn),sex="male")
tmp_female=data.frame(clo=NA,tOut=seq(min(df2$tOut),max(df2$tOut),0.1),tIn=mean(df2$tIn),sex="female")
new=rbind(tmp_male,tmp_female)

w = rep(0, length(new[,1]))
w[new$sex == 'female'] = opt$par 
w[new$sex =='male'] = 1


conf = predict(fit,new,weights = 1/w, interval = 'confidence')
pred = predict(fit, new,weights = 1/w, interval = 'prediction')

out = data.frame(cbind(new, conf, pred))
q2 = ggplot(data  = out, aes(x = tOut, y = fit, col = sex)) + geom_line()+   
  geom_line(aes(x = tOut, y = lwr), lty = 2)+ geom_line(aes(x = tOut, y = upr), lty = 2)+
  geom_line(aes(x = tOut, y = upr.1), lty = 2) + geom_line(aes(x = tOut, y = lwr.1), lty = 2)+
  geom_point(data = df2, aes(x = tOut, y = clo, col= as.factor(sex))) + facet_wrap(~sex) + 
  labs(title="Mean of indoor operating temperature (tInOp = 26.82)",
        x ="Outdoor temperature (tOut)", y = "Clothing level (clo)")+ theme(plot.title = element_text(hjust = 0.5))

#75 % quantile
tmp_male=data.frame(clo=NA,tOut=seq(min(df2$tOut),max(df2$tOut),0.1),tIn=quantile(df2$tIn,0.75),sex="male")
tmp_female=data.frame(clo=NA,tOut=seq(min(df2$tOut),max(df2$tOut),0.1),tIn=quantile(df2$tIn,0.75),sex="female")
new=rbind(tmp_male,tmp_female)
w = rep(0, length(new[,1]))
w[new$sex == 'female'] = opt$par 
w[new$sex =='male'] = 1


conf = predict(fit,new,weights = 1/w, interval = 'confidence')
pred = predict(fit, new,weights = 1/w, interval = 'prediction')

out = data.frame(cbind(new, conf, pred))

q3 = ggplot(data  = out, aes(x = tOut, y = fit, col = sex)) + geom_line()+   
  geom_line(aes(x = tOut, y = lwr), lty = 2)+ geom_line(aes(x = tOut, y = upr), lty = 2)+
  geom_line(aes(x = tOut, y = upr.1), lty = 2) + geom_line(aes(x = tOut, y = lwr.1), lty = 2)+
  geom_point(data = df2, aes(x = tOut, y = clo, col= as.factor(sex))) + facet_wrap(~sex) + 
  labs(title="75% Quantile of indoor operating temperature (tInOp = 27.48)",
        x ="Outdoor temperature (tOut)", y = "Clothing level (clo)")+ theme(plot.title = element_text(hjust = 0.5))

grid.arrange(q1,q2,q3)
```


From figure \ref{fig:pred_2} it can be seen that the prediction interval for the females are more wide compared to the unweighted model and more points are within the prediction interval. Clearly, it can be seen that the prediction interval for females are more wide compared to males, which might be due to the weighting of the residuals. 


```{r res_4, fig.height=6,fig.cap="The figure presents the residuals of the weighted model"}
par(mfrow = c(2,2))
plot(fit)
```

From figure \ref{fig:res_4} it can be seen that the Normal-QQ plot clearly has improved compared to the one in figure \ref{fig:res_1}. All points except point 22 appear to follow the QQ-line nicely. From the Residuals vs Leverage plot it can be seen that point 22 has a low leverage and therefore does not affect the model fit substantially and further investigation of this point are omitted. From the Residuals vs Fitted and Scale-location plots the residuals appears to be randomly distributed. Clearly the weighted residual model improved the model fit. 

Figure \ref{fig:res_5} shows the residuals when looking at the subject ID, and from this it can clearly be seen that the subject ID contains information about the variance in the residuals. The subject ID should therefore be included in the modeling. 

```{r res_5, fig.height = 4, fig.cap = "The figure presents the residuals as a function of the subject ID."}
df2$residuals = resid(fit)
df2$subj_number = 1:nrow(df2)
ggplot(data = df2, aes(x = subj_number, y = residuals, col = as.factor(subjId))) + geom_point() + geom_line() + 
  xlab('Index') + ggtitle('Residuals of observations')+facet_wrap(~as.factor(sex))+ theme(plot.title = element_text(hjust = 0.5))

```





