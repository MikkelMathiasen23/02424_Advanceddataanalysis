---
output: html_document
editor_options: 
  chunk_output_type: console
chunk_output_type: console
---

```{r}
source('setup.R')
```

# Problem B

As we saw from the residuals in Problem A, some of the individuals do produce residuals that are either all positive or all negative. This could indicate that the individuals could have different base preferences of clothing. That is, one individual might be be warm most of the time and therefore wear less clothing. Likewise an individual might often be cold and would therefore wear more clothes. This could indicate that our model should have an individual intercept. 

We cannot estimate any models with both an interaction between both of the indoor/outdoor temperatures and an individual intercept because of our degrees of freedom. Third order interactions are therefore also not possible. We can however estimate a model with an interaction between either the indoor or outdoor temperature and the individuals. This will lead to either of the following models:

\begin{equation}\label{eq:prob2_full1}
\begin{aligned}
y_i=&\beta_0+a\cdot \beta_1 \cdot t_{in,i}+\beta_2 \cdot t_{out,i}+\beta_3\cdot t_{in,i}\cdot t_{out,i}+a(sex_i)+b(t_{in,i},sex_i)+c(t_{in,i},sex_i)+d(individual_i)+e(t_{in,i},individual_i)\\
&\gamma(t_{out,i},sex_i)+
\end{aligned}
\end{equation}

\begin{equation}\label{eq:prob2_full2}
\begin{aligned}
y_i=\mu+a\cdot b \cdot t_{in,i}+c \cdot t_{out,i}+d\cdot t_{in,i}\cdot t_{out,i}+\alpha(sex_i)+\beta(t_{in,i},sex_i)+\beta(t_{in,i},sex_i)\\
y_i=\mu+a\cdot b \cdot t_{in,i}+c \cdot t_{out,i}+d\cdot t_{in,i}\cdot t_{out,i}+\alpha(sex_i)+\gamma(t_{out,i},sex_i)
\end{aligned}
\end{equation}

The following table shows the initial models with either an interaction between the indoor/ temperature and the individuals:

```{r}
df2=read.csv(file="./Data/clothingSum.csv")
df2$subjId = as.character(df2$subjId)
fitB = lm( clo ~ tOut*tInOp+subjId*tOut,data = df2)
m1=Anova(fitB,type=3)
fitB = lm( clo ~ tOut*tInOp+subjId*tInOp,data = df2)
m2=Anova(fitB,type=3)
xtable(rbind(m1,m2),digits=c(0,3,0,3,3))
summary(fitB)

```
\begin{table}[H]
\centering
\begin{tabular}{ccccc}
  \hline
 & Sum Sq & Df & F value & Pr($>$F) \\ 
  \hline
(Intercept) & 0.022 & 1 & 3.386 & 0.073 \\ 
  tOut & 0.023 & 1 & 3.446 & 0.071 \\ 
  tInOp & 0.017 & 1 & 2.531 & 0.120 \\ 
  subjId & 0.480 & 46 & 1.571 & 0.074 \\ 
  tOut:tInOp & 0.023 & 1 & 3.417 & 0.072 \\ 
  tOut:subjId & 0.442 & 46 & 1.449 & 0.117 \\ 
  Residuals & 0.266 & 40 &  &  \\ 
  \hline
  (Intercept)1 & 0.002 & 1 & 0.270 & 0.606 \\ 
  tOut1 & 0.015 & 1 & 1.695 & 0.200 \\ 
  tInOp1 & 0.004 & 1 & 0.417 & 0.522 \\ 
  subjId1 & 0.370 & 46 & 0.925 & 0.603 \\ 
  tOut:tInOp1 & 0.019 & 1 & 2.176 & 0.148 \\ 
  tInOp:subjId & 0.360 & 46 & 0.899 & 0.639 \\ 
  Residuals1 & 0.348 & 40 &  &  \\ 
   \hline
\end{tabular}
\caption{The first rows (until the horizontal line) significant parameters for a model with an interaction term between the outdoor temperature and the individuals. Below the horizontal line we have a model with interaction term between the indoor temperature and the indivuduals. We can see that none of these interaction terms between the individuals and the temperature are significant. Furthermore we see that those are the first terms to be dropped. We used a type 3 for the model deviance table.}
\label{tab:prob2_init}
\end{table}

\cref{tab:prob2_init} shows that neither of the interaction terms between the temperatures and the individuals are significant. Therefore we can continue with finding our optimal model. 

```{r}

# fit2B = lm( clo ~ tOut+tInOp+subjId,data = df2)
# summary(fit2B)
# 
# fit3B = lm( clo ~ tOut+subjId,data = df2)
# summary(fit3B)
# plot(fit3B)
# #Eventuelt plot coefficienter for hver subjId
# 
# qqnorm(resid(fit3B))                   
# qqline(resid(fit3B))
# 
# 
# #Question 2: 
# hist(fit3B$coefficients[3:length(fit3B$coefficients)], nclass= 12)
# l = length(fit3B$coefficients)
# 
# qqnorm(fit3B$coefficients[3:length(fit3B$coefficients)])
# qqline(fit3B$coefficients[3:length(fit3B$coefficients)])
# 
# 
# std_coef = sqrt(diag(vcov(fit3B)))[3:l]
# coef_est = fit3B$coefficients[3:l]
# 
# df_coef = data.frame(cbind(coef_est, confint(fit3B)[3:l,]))
# df_coef$names =rownames(df_coef)
# df_coef$sex = NaN
# library(stringr)
# 
# for (i in 1:(l-2)){
#   
#   df_coef$sex[i] = df2$sex[str_extract(df_coef$names[i],"([0-9]{1,3})")==df2$subjId] 
# }
# 
# df_coef$names = as.numeric(str_extract(df_coef$names,"([0-9]{1,3})"))
# df_coef = df_coef[order(as.numeric(df_coef$names)),]
# df_coef$names = as.factor(df_coef$names)
# levels(df_coef$names)
# 
# 
# ggplot(data = df_coef, aes(x = names, y = coef_est, color = sex)) + 
#   geom_pointrange(aes(ymin=X2.5.., ymax=X97.5..)) + 
#   theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

